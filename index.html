<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng Tra H∆∞·ªõng Nh√† Phong Th·ªßy</title>
    <style>
        /* === C∆† S·ªû CHUNG === */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* === TAB NAVIGATION === */
        .tab-controls {
            display: flex;
            width: 100%;
            max-width: 600px;
            margin-bottom: 10px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab-button {
            flex-grow: 1;
            padding: 15px 0;
            text-align: center;
            border: none;
            background-color: #eee;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        /* === TAB CONTENT (MAP VIEW) === */
        .tab-content {
            width: 100%;
            max-width: 600px;
            padding: 10px;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }
        .tab-content.active {
            display: block; /* Hi·ªán th·ªã tab ƒëang active */
        }
        
        #map-container {
            width: 100%;
            height: 350px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* === TAB CONTENT (COMPASS VIEW) === */
        #compass-view {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #compass-info {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        #compass-container {
            position: relative;
            width: 90vmin; 
            max-width: 400px;
            height: 90vmin;
            max-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #ccc; /* Th√™m ƒë∆∞·ªùng vi·ªÅn */
            border-radius: 50%;
            overflow: hidden;
        }
        #bagua-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform-origin: center;
            /* B·ªè transition trong CSS ƒë·ªÉ s·ª≠ d·ª•ng requestAnimationFrame cho ƒë·ªô m∆∞·ª£t t·ªëi ∆∞u h∆°n */
        }
        #permission-button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="tab-controls">
        <button class="tab-button active" onclick="openTab('map-view', this)">üß≠ Xem V·ªã Tr√≠ ƒê·∫•t</button>
        <button class="tab-button" onclick="openTab('compass-view', this)">üìê ƒêo H∆∞·ªõng B√°t Tr·∫°ch</button>
    </div>

    <div id="map-view" class="tab-content active">
        <p style="text-align: center; color: #555;">S·ª≠ d·ª•ng b·∫£n ƒë·ªì ƒë·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ m·∫£nh ƒë·∫•t, sau ƒë√≥ chuy·ªÉn sang tab ƒêo H∆∞·ªõng.</p>
        <div id="map-container">
            <iframe 
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3919.1437651036327!2d106.69970367355799!3d10.800000000000004!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752f360946d47b%3A0x6715f6b2164f9f7a!2zTMOyIE1p4buNbmcsIFBo4bqhbSBOZ-G7jWMgUXXpIiwgQmluZ2ggVGjhuqFuaCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFt!5e0!3m2!1svi!2s!4v1633000000000!5m2!1svi!2s" 
                allowfullscreen="" 
                loading="lazy" 
                referrerpolicy="no-referrer-when-downgrade">
            </iframe>
        </div>
    </div>

    <div id="compass-view" class="tab-content">
        <div id="compass-info">
            H∆∞·ªõng hi·ªán t·∫°i: <span id="current-heading">0.0¬∞</span> (B·∫Øc l√† $0^\circ$)
        </div>

        <button id="permission-button">
            K√≠ch ho·∫°t La B√†n
        </button>
        
        <div id="compass-container">
            <img id="bagua-image" src="/images/anhlaban.png" alt="La Kinh B√°t Tr·∫°ch">
        </div>
    </div>

    <script>
        // === LOGIC CHUY·ªÇN TAB ===
        function openTab(tabId, tabButton) {
            // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // Lo·∫°i b·ªè active t·ª´ t·∫•t c·∫£ n√∫t
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Hi·ªÉn th·ªã n·ªôi dung tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(tabId).classList.add('active');
            // ƒê√°nh d·∫•u n√∫t ƒëang active
            tabButton.classList.add('active');
        }

        // === LOGIC LA B√ÄN V√Ä XOAY H√åNH ·∫¢NH ===
        document.addEventListener('DOMContentLoaded', () => {
            const baguaImage = document.getElementById('bagua-image');
            const currentHeadingDisplay = document.getElementById('current-heading');
            const permissionButton = document.getElementById('permission-button');

            let targetHeading = 0; // H∆∞·ªõng m·ª•c ti√™u t·ª´ la b√†n (0-360)
            let currentRotation = 0; // V·ªã tr√≠ xoay hi·ªán t·∫°i c·ªßa h√¨nh ·∫£nh (t·ª´ 0 ƒë·∫øn -360)

            // H√†m l√†m m∆∞·ª£t chuy·ªÉn ƒë·ªông (Smoothing function)
            function smoothRotation() {
                // T√≠nh to√°n h∆∞·ªõng xoay mong mu·ªën (-targetHeading)
                let desiredRotation = -targetHeading;

                // T·ªëi ∆∞u h√≥a ƒë·ªÉ xoay theo ƒë∆∞·ªùng ng·∫Øn nh·∫•t
                while (desiredRotation - currentRotation > 180) {
                    currentRotation += 360;
                }
                while (desiredRotation - currentRotation < -180) {
                    currentRotation -= 360;
                }

                // D√πng h·ªá s·ªë l√†m m∆∞·ª£t (v√≠ d·ª•: 0.1)
                // Gi√° tr·ªã n√†y c√†ng nh·ªè th√¨ chuy·ªÉn ƒë·ªông c√†ng m∆∞·ª£t nh∆∞ng ph·∫£n h·ªìi ch·∫≠m h∆°n
                const smoothingFactor = 0.15;
                currentRotation += (desiredRotation - currentRotation) * smoothingFactor;

                // √Åp d·ª•ng xoay
                baguaImage.style.transform = `rotate(${currentRotation.toFixed(2)}deg)`;

                // Ti·∫øp t·ª•c g·ªçi h√†m n√†y ·ªü frame ti·∫øp theo
                requestAnimationFrame(smoothRotation);
            }

            // H√†m x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ c·∫£m bi·∫øn la b√†n
            function handleDeviceOrientation(event) {
                let newHeading;

                if (event.webkitCompassHeading !== undefined) {
                    // D√†nh cho Safari tr√™n iOS: D·ªØ li·ªáu la b√†n tr·ª±c ti·∫øp (0-360)
                    newHeading = event.webkitCompassHeading;
                } else if (event.alpha !== null) {
                    // D√†nh cho c√°c tr√¨nh duy·ªát kh√°c: C·∫ßn t√≠nh to√°n l·∫°i (alpha l√† h∆∞·ªõng so v·ªõi tr·ª•c Z)
                    // newHeading = 360 - event.alpha; 
                    // D√πng alpha th∆∞·ªùng kh√¥ng ch√≠nh x√°c v√† ·ªïn ƒë·ªãnh b·∫±ng webkitCompassHeading
                    return; 
                } else {
                    return; // Kh√¥ng c√≥ d·ªØ li·ªáu h∆∞·ªõng
                }
                
                targetHeading = newHeading; // C·∫≠p nh·∫≠t h∆∞·ªõng m·ª•c ti√™u
                currentHeadingDisplay.textContent = `${newHeading.toFixed(1)}¬∞`;
            }

            // H√†m y√™u c·∫ßu c·∫•p quy·ªÅn truy c·∫≠p la b√†n (B·∫Øt bu·ªôc tr√™n iOS 13+ Safari)
            function requestDeviceOrientationPermission() {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleDeviceOrientation);
                                permissionButton.style.display = 'none'; // ·∫®n n√∫t
                                smoothRotation(); // B·∫Øt ƒë·∫ßu l√†m m∆∞·ª£t
                            } else {
                                currentHeadingDisplay.textContent = '‚õî Kh√¥ng ƒë∆∞·ª£c c·∫•p quy·ªÅn la b√†n.';
                                alert('Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p la b√†n trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.');
                            }
                        })
                        .catch(err => {
                             currentHeadingDisplay.textContent = '‚ùå L·ªói h·ªá th·ªëng la b√†n.';
                             console.error(err);
                        });
                } else {
                    // C√°c tr√¨nh duy·ªát kh√¥ng c·∫ßn quy·ªÅn
                    window.addEventListener('deviceorientation', handleDeviceOrientation);
                    permissionButton.style.display = 'none';
                    smoothRotation(); // B·∫Øt ƒë·∫ßu l√†m m∆∞·ª£t
                }
            }

            // G·∫Øn s·ª± ki·ªán click cho n√∫t y√™u c·∫ßu quy·ªÅn
            permissionButton.addEventListener('click', requestDeviceOrientationPermission);
        });
    </script>
</body>
</html>
